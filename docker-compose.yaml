# YAML Anchors - Common service definitions (HIGH-002)
x-minion-base: &minion-base
  restart: "no"
  privileged: true
  networks:
    - salt-net
  depends_on:
    salt-master:
      condition: service_healthy

x-minion-healthcheck: &minion-healthcheck
  test: ["CMD-SHELL", "test -f /var/log/salt/minion && tail -1 /var/log/salt/minion | grep -q . || exit 1"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 90s

services:
  salt-master:
    build:
      context: .
      dockerfile: Dockerfile.linux-master
    container_name: salt-master
    restart: unless-stopped
    ports:
      - "4505:4505"  # Master pub (ZeroMQ)
      - "4506:4506"  # Minion ret (ZeroMQ)
    volumes:
      # Salt file roots - use bind mount with subpath
      - ./srv/salt:/srv/salt:ro
      - ./srv/pillar:/srv/pillar:ro
      # Provisioning files - mount to separate location, configure via file_roots
      - ./provisioning:/srv/provisioning:ro
      # Pre-shared minion public keys for auto-acceptance during testing
      # Mount only .pub files individually (private .pem keys stay on minions)
      - ./srv/salt/keys/ubuntu-test.pub:/etc/salt/pki/master/minions_pre/ubuntu-test
      - ./srv/salt/keys/rhel-test.pub:/etc/salt/pki/master/minions_pre/rhel-test
      # Persistent data
      - salt-cache:/var/cache/salt
      - salt-logs:/var/log/salt
      - salt-pki:/etc/salt/pki/master
      # Master config (file_roots.conf, auto_accept.conf generated by entrypoint)
      - ./srv/master.d:/etc/salt/master.d
    networks:
      - salt-net
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "4505"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Ubuntu test minion - auto-applies highstate on startup
  salt-minion-ubuntu:
    <<: *minion-base
    build:
      context: .
      dockerfile: Dockerfile.ubuntu-minion
    container_name: salt-minion-ubuntu-test
    environment:
      - SALT_MASTER=salt-master
      - MINION_ID=ubuntu-test
    volumes:
      # Pre-shared minion keys (bind mount from srv/salt/keys)
      - ./srv/salt/keys/ubuntu-test.pem:/etc/salt/pki/minion/minion.pem:ro
      - ./srv/salt/keys/ubuntu-test.pub:/etc/salt/pki/minion/minion.pub:ro
    healthcheck: *minion-healthcheck
    profiles:
      - test-ubuntu

  # RHEL test minion - auto-applies highstate on startup
  salt-minion-rhel:
    <<: *minion-base
    build:
      context: .
      dockerfile: Dockerfile.rhel-minion
    container_name: salt-minion-rhel-test
    environment:
      - SALT_MASTER=salt-master
      - MINION_ID=rhel-test
    volumes:
      # Pre-shared minion keys (bind mount from srv/salt/keys)
      - ./srv/salt/keys/rhel-test.pem:/etc/salt/pki/minion/minion.pem:ro
      - ./srv/salt/keys/rhel-test.pub:/etc/salt/pki/minion/minion.pub:ro
    healthcheck: *minion-healthcheck
    profiles:
      - test-rhel

  # Windows Desktop test minion via Dockur (requires KVM on Linux host)
  # This runs actual Windows 11 Desktop in a VM-like container using QEMU+KVM
  # Access via web interface at http://localhost:8006 (login: Docker/admin)
  salt-minion-windows:
    image: dockurr/windows
    container_name: salt-minion-windows-test
    restart: "no"
    environment:
      VERSION: "11"           # Windows 11 Pro
      RAM_SIZE: "4G"          # 4GB RAM
      CPU_CORES: "2"          # 2 vCPUs
      DISK_SIZE: "64G"        # 64GB virtual disk
      # MANUAL: "N"           # Unattended install (requires Autounattend.xml)
    devices:
      - /dev/kvm              # Requires KVM support (Linux only)
      - /dev/net/tun          # Required for networking
    cap_add:
      - NET_ADMIN             # Required for network management
    ports:
      - 8006:8006             # Web VNC interface
      - 3389:3389             # RDP (optional, for direct access)
    volumes:
      - ./windows-test:/storage                          # Persistent Windows storage
      - ./scripts:/mnt/scripts:ro                        # Mount scripts for Salt install
      - ./srv/salt/keys:/mnt/keys:ro                     # Pre-shared minion keys
    networks:
      - salt-net
    depends_on:
      salt-master:
        condition: service_healthy
    profiles:
      - test-windows

  # Legacy: Windows Server test minion (requires Windows Docker host)
  # Commented out in favor of Dockur approach above
  # salt-minion-win-server:
  #   image: mcr.microsoft.com/windows/servercore:ltsc2022
  #   platform: windows/amd64
  #   container_name: salt-minion-win-server-test
  #   restart: "no"
  #   volumes:
  #     - ./scripts:/scripts:ro
  #     - ./srv/salt/keys/win-test.pem:C:/salt/conf/pki/minion/minion.pem:ro
  #     - ./srv/salt/keys/win-test.pub:C:/salt/conf/pki/minion/minion.pub:ro
  #   environment:
  #     - SALT_MASTER=salt-master
  #     - MINION_ID=win-server-test
  #   entrypoint: ["powershell", "-ExecutionPolicy", "Bypass", "-File", "/scripts/enrollment/install-windows-minion.ps1"]
  #   networks:
  #     - salt-net
  #   depends_on:
  #     - salt-master
  #   profiles:
  #     - test-windows-server

volumes:
  salt-cache:
  salt-logs:
  salt-pki:
  salt-minion-ubuntu-pki:
  salt-minion-rhel-pki:

networks:
  salt-net:
