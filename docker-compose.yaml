services:
  salt-master:
    build:
      context: .
      dockerfile: Dockerfile.master
    container_name: salt-master
    restart: unless-stopped
    environment:
      # Auto-accept minion keys: true (testing), false (production)
      - SALT_AUTO_ACCEPT=true
    ports:
      - "4505:4505"  # Master pub (ZeroMQ)
      - "4506:4506"  # Minion ret (ZeroMQ)
    volumes:
      # Salt file roots - use bind mount with subpath
      - ./srv/salt:/srv/salt:ro
      - ./srv/pillar:/srv/pillar:ro
      # Provisioning files - mount to separate location, configure via file_roots
      - ./provisioning:/srv/provisioning:ro
      # Pre-shared minion keys (optional, used for automated testing )
      - ./srv/salt/keys:/etc/salt/pki/master/minions_pre
      # Persistent data
      - salt-cache:/var/cache/salt
      - salt-logs:/var/log/salt
      - salt-pki:/etc/salt/pki/master
      # Master config (file_roots.conf, auto_accept.conf generated by entrypoint)
      - ./srv/master.d:/etc/salt/master.d
    networks:
      - salt-net
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "4505"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Linux test minion - auto-applies highstate on startup
  salt-minion-linux:
    build:
      context: .
      dockerfile: Dockerfile.linux-minion
    container_name: salt-minion-linux-test
    restart: "no"
    volumes:
      # Pre-shared keys (optional, for automated testing without auto-accept)
      - ./srv/salt/keys/linux-test.pem:/etc/salt/pki/minion/minion.pem:ro
      - ./srv/salt/keys/linux-test.pub:/etc/salt/pki/minion/minion.pub:ro
    environment:
      - SALT_MASTER=salt-master
      - MINION_ID=linux-test
    networks:
      - salt-net
    depends_on:
      salt-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'tail -f /var/log/salt/minion' >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    profiles:
      - test-linux

  # Windows test minion (requires Windows Docker host)
  salt-minion-win:
    image: mcr.microsoft.com/windows/servercore:ltsc2022
    platform: windows/amd64
    container_name: salt-minion-win-test
    restart: "no"
    volumes:
      - ./scripts:/scripts:ro
      # Pre-shared keys (optional, for automated testing without auto-accept)
      - ./srv/salt/keys/win-test.pem:C:/salt/conf/pki/minion/minion.pem:ro
      - ./srv/salt/keys/win-test.pub:C:/salt/conf/pki/minion/minion.pub:ro
    environment:
      - SALT_MASTER=salt-master
      - MINION_ID=win-test
    entrypoint: ["powershell", "-ExecutionPolicy", "Bypass", "-File", "/scripts/install-win-minion.ps1"]
    networks:
      - salt-net
    depends_on:
      - salt-master
    profiles:
      - test-windows

volumes:
  salt-cache:
  salt-logs:
  salt-pki:

networks:
  salt-net:
