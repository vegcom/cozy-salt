# Test environment: extends base compose with test minions
# Usage: docker compose -f docker-compose.yaml -f docker-compose-test.yaml up

services:
  # Linux test minion - auto-applies highstate on startup
  salt-minion-linux:
    build:
      context: ./tests
      dockerfile: Dockerfile.linux-minion
    container_name: salt-minion-linux-test
    restart: "no"
    environment:
      - SALT_MASTER=salt-master
      - MINION_ID=linux-test
    networks:
      - salt-net
    depends_on:
      salt-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "salt-call --local state.show_highstate --out=json 2>/dev/null | grep -q '\"result\": true' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    profiles:
      - test

  # Windows test minion (requires Windows Docker host + --profile windows)
  salt-minion-win:
    image: mcr.microsoft.com/windows/servercore:ltsc2022
    platform: windows/amd64
    container_name: salt-minion-win-test
    restart: "no"
    volumes:
      - ./scripts:/scripts:ro
    environment:
      - SALT_MASTER=salt-master
      - MINION_ID=win-test
    entrypoint: ["powershell", "-ExecutionPolicy", "Bypass", "-File", "/scripts/install-win-minion.ps1"]
    networks:
      - salt-net
    depends_on:
      - salt-master
    profiles:
      - windows  # Only with: docker compose --profile windows up
      - test
